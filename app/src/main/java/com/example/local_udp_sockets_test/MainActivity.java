
package com.example.local_udp_sockets_test;

import androidx.appcompat.app.AppCompatActivity;
import androidx.localbroadcastmanager.content.LocalBroadcastManager;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.media.MediaPlayer;
import android.media.MediaRecorder;
import android.os.Bundle;
import android.os.ParcelFileDescriptor;
import android.util.Log;
import android.view.View;
import android.widget.Button;

import com.example.local_udp_sockets_test.audio_pipeline_recording.AACADTSFramePacketizer;
import com.example.local_udp_sockets_test.audio_pipeline_recording.AACADTSFrameProcessor;
import com.example.local_udp_sockets_test.helpers.InterModuleInfo;

import net.named_data.jndn.Data;
import net.named_data.jndn.Name;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;

public class MainActivity extends AppCompatActivity {

    private static final String TAG = "MainActivity";
    Button button_;
    int currentBundleNum_ = 0;

    BroadcastReceiver AACADTSFrameProcessorListener = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            Data audioPacket = AACADTSFramePacketizer.generateAudioDataPacket(new Name("/dummy/name"),
                    intent.getByteArrayExtra(InterModuleInfo.AAC_ADTS_Frame_Processor_EXTRA_AUDIO_BUNDLE_ARRAY));

            Log.d(TAG, "Name of audio data packet: " + audioPacket.getName());
            Log.d(TAG, "Contents of audio data packet: " + Helpers.bytesToHex(audioPacket.getContent().getImmutableArray()));

            try {
                File audioFile = new File(getExternalCacheDir().getAbsolutePath() + "/" + currentBundleNum_ + ".aac");
                FileOutputStream os = new FileOutputStream(audioFile);
                os.write(audioPacket.getContent().getImmutableArray());
                os.close();
                currentBundleNum_++;
            }
            catch (IOException e) { e.printStackTrace(); }


        }
    };

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        button_ = (Button) findViewById(R.id.button);
        button_.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                final MediaPlayer player = new MediaPlayer();
                player.setOnCompletionListener(new MediaPlayer.OnCompletionListener() {
                    @Override
                    public void onCompletion(MediaPlayer mp) {
                        try {
                            player.release();
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                });
                try {
                    File audioBundleFile = new File(getExternalCacheDir().getAbsolutePath() + "/1.aac");
                    player.setDataSource(audioBundleFile.getAbsolutePath());
                    player.prepare();
                    player.start();
                }
                catch (IOException e) {
                    e.printStackTrace();
                }
            }
        });

        LocalBroadcastManager.getInstance(this).registerReceiver(AACADTSFrameProcessorListener,
                                                                    AACADTSFrameProcessor.getIntentFilter());

        ParcelFileDescriptor[] mParcelFileDescriptors = null;
        ParcelFileDescriptor mParcelRead;
        ParcelFileDescriptor mParcelWrite;

        AACADTSFrameProcessor mPacketizer = new AACADTSFrameProcessor(this, getExternalCacheDir());

        // create an array of parcel file descriptors
        try {
            mParcelFileDescriptors = ParcelFileDescriptor.createPipe();
        } catch (IOException e) {
            e.printStackTrace();
        }
        mParcelRead = new ParcelFileDescriptor(mParcelFileDescriptors[0]);
        mParcelWrite = new ParcelFileDescriptor(mParcelFileDescriptors[1]);

        // create the recorder object to record audio and stream it to the local socket
        MediaRecorder recorder = new MediaRecorder();
        recorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);
        recorder.setOutputFormat(MediaRecorder.OutputFormat.AAC_ADTS);
        recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);
        recorder.setAudioChannels(1);
        recorder.setAudioSamplingRate(8000);
        recorder.setAudioEncodingBitRate(10000);
        recorder.setOutputFile(mParcelWrite.getFileDescriptor());

        Log.d(TAG, "Recording started...");
        try {
            recorder.prepare();
            recorder.start();
        } catch (IOException e) {
            e.printStackTrace();
        }

        InputStream is = new ParcelFileDescriptor.AutoCloseInputStream(mParcelRead);

        // set the packetizer to read the MediaRecorder's stream and packetize its ADTS frames
        mPacketizer.setInputStream(is);
        mPacketizer.start();

        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        recorder.stop();
        mPacketizer.stop();
        Log.d(TAG, "Recording stopped.");

        // code for writing a hex string into a file
//        String test_aac_file_hex_string = "FFF16C4014FFFC00EC3400C26030842A405A2739FCCBFDE7FCBD43F6BC01F9CFF6BA716F73000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E0FFF16C4014FFFC011434110380089CD84162004C58BBBCACAE968A9EEACB83CA77B6BF4357449A347512B564D3584AB2DCF04FC1A79C07F570BEF6CD9FB52C8B5CFC10DF74896BE1B3617B46C2D254B6C8A0A5CA042ED54BB55EDF0008FC26121AD0003626906A29702416B6C2330AA51BA53000A00D0044000A5C130000378C000000000000000000000000000000000000000000000000000000000000000000000000000070FFF16C4014FFFC010E341884A1D04050B5282D57858942C28082BA6B6B8B4951CDCB9A57534C3FCF0B6ED5E6B270D537397A6D8E2DEF59A2747D21B246AD21813A5211877B046570585051680802E2E0715C2A0B858A0028B2CB2001103BAB74A80101700058985AB60A012021100014144E62E94006F210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000EFFF16C4014FFFC010E341603700ABC38019B0F8A2F05CA2CCC5AD14BB8E79E42E5BFBFB9BE08DD6F7B9082A195D6964AD49A4D593170011A1A40556F7435AD6B5A2B7BDEC003A02598873025126DA5EE4684D72800E60340515A8082E0264549D5338583B854415004AE0B003F589FD07E217540914A0541BC78000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380FFF16C4014FFFC0112541064D1C3C63CACED8A1D38C0BE5D522191D87A1272C1B44A268741065AAF50F9EF739D2ED07BA52170796A0297C27DFDCB23FF0610E80880B21511906DA73574437D2CA496338A04B39101AC0B7E0E2808CEA009C44CEC160485A71B277904828B577588018AA6E098A500A0BC0100B4C002E0378C80000000000000000000000000000000000000000000000000000000000000000000000000000070FFF16C4015FFFC01109ED87866357B1A3188A4A2D726160E0C6743C27747A0D5F5A3DF930593EE7D86021222C078EE95BB0D6B9EC578EF9BB3EDFE0A9500545AD669952E804153DDE61B0246C6AECD976433D9A88370E4DDC5D14260A5C04CB26000240B861028D5DA83167DE4C6E68C5466E60BA4814286504934A0836DA5F9CE994CCBD16ABD97E4A9128BB1189489F896002C425E7080541590F2E75A5B47086EFF93A202ABB996DC102A55D038FFF16C4013FFFC0118F40D430218AC60E7C78C16BC60252222D5934097B4EAAFB3F67D7D69D61C086198D65094DA72CB0F36EF6757926C457B1A42C291BD3129911ED50F0A754E8253306299BB262DEB98663D74BE70EAE26F00C75AFB2901DA5E50ADC6C85B36D856B82D8386FCB88EF09FB0008CD500D80511001113690002D1BD95220009A8840006F0500000000000000000000000000000000000000EFFF16C4014FFFC0120540D24432129022C0B19F9A004002177559A5A25108444723FB7F59837FE07E80566B11AA7027D50CF9C683FDCFD14EE8BC934A89E11CD123F04BCE76BDF9DE841FA0C84BEA4130D5804FA107F80343E6DC0030003DA169731B9FB2FBA95FE8B1FFAED2D54C8116314322AB53F4F0B0FE83F8F429DBC3702A032C2E00B801700F300100096005D9000018C01BC0400000000000000000000000000000380FFF16C4016BFFC01129FA4FC02240893FCCA8A3CC4B4D06872FCBF5EFBF8BFDBF207C1C6BAF77D8037A6B9289BE37AA21222C8AB81C4586BFBBF2B080E30643FB192098239C4B4B307DB003F70000A41D53F982483903180909D9C618C09004128006FF547CD701EE4311234D7F08DFB9C7F7FE9A5504E004030826D96834FA12ADCFEAB0FACACA2C7D14F2B2D471D228B1B1986533998D508C472A249773E8DBE75BE910AF13F1BAF12CE193A0CF8FC0839F54380FFF16C40133FFC0156F424A02A088EC2A63B0DA40662062D69E5CAF9BD6F20C71059000BC78BF5CC00882091FC0F9E4E3116714CC4C79545C569718C4DDE26CA0567E1F776C00000BEFF8D801A38000ECA0080E85FAFA0974368BC1ECBB3002500E2A17500068004A290017005219E2EB8A00020AA05005800B4A00CC91CFAD403ADA803782800000000000000000000000000000000000007FFF16C4014FFFC014A3424A02A0A8EC202608890226609945201726616A300D516D56D72A8200561202A37FE0FFFBBF79E0C01EF11BE4F697DD8005EB5AFF4E93E4B69B9A1C00B9CB0F4E384091F03441403EF7BC405FF2D7E8CA05B3B3A5ACF3494D187FFA5E5096AF4CD6D6EB73734240E9510001A4130B00DC7C674DF75429F9800006D8002BD800CDA10D5EEF363C1E1977B597B8E9FC286C000000000000000000000000EFFF16C4014FFFC0152341476101D8405620149C02E1360044828D0A28381055ED07AB20200000D88F003A5297692F1CA000043609109E4C7D983BF1A15ADDDBD37A6D00000BD5EC7B8FAFF74D920001ADD378DFB5F4F9A03E0F6BC2D99C803FB57AAF65BF003AB880975BA1CF004801CD4002D4B004AD1013FA2FD0B97C888066010578007C149829E1F762CE8079BC52C7EAF883C91F75EF9806B0000000000000000000000E0FFF16C4014FFFC01583424A02B088EC2027200A4A260088C02240AE18D000357CAB8C04002000DDF8F79480018C5DA57A2E0CE096093BAFBC27848357C5FF0FFAFAF006800C7A9F83FE9FD3D35EAF4BF72EE3C7902E32E26028965D0749A1800CF3CC09DCD0800534801AF40052B9E229003381F3804053E51571EBA005829790032C439CAA4BC1F3CDBADBFE39A87306C0A4401BC080000000000000000000000000000000380FFF16C4014FFFC014634147615080AC203B0809C269719B54E46CC08B06945F1E0060215EDC00006A09385D1BEA001A1DA5EC92025EDECAACF899E5286AF23D56D004FE66200F0B6E200FAAD4001BB9FF77AD500C59D813D6F0B4300C41976A0013D104434A200CBE56233575206EF86A66C2C64AB006FC58100BC01122B00196911BA09F43DC44BE92357D8B86C34801BC1800000000000000000000000000000000000000038FFF16C4014FFFC014E340C741315080303431C802231DC08A02E94A26B46F6B8F604FCFFDF7380EDE7F17E293F8A044F30D1A48622B19BF62C8D2A8CBCBAB150C8DA623D4E3E478F884E7108C3C3C3D6207DD51F100061853BBA486701553501567140D034FABDDF9D620EA2FA1ADC1C1BD80A8150CC09C031001C0040A804E368EAF44B8069D71480000A89C2D0260020904A20517E0DE000000000000000000000000000001CFFF16C4014FFFC0158340474101504C5427230470DB428AC582A347B34CED2EFBCD0817050FA218041385498ED72E9C7E6BC60406C0E7BDBBC461191A3451E015CAF4BE071FAFD390007BE7B2DCA0018B27E1F9C417F57F5FBC02993FAE9E20E71CB7B0307F18809C80480130A8C70012C55013512B0F363860870B8005AA0200EA442800489DE412B8017BDA60001BC1C00000000000000000000000000000000000000000380FFF16C4014FFFC015034107611158405629280A4673420DAC50B1A0BEED78B0F53B8E03A93651CE2520E5D5C014A6D000A52903289458016C3BA2D463A0E9600020657F29FC1000053BDFBB6CDDA5EA5B28000745E95FA5F4FA7204FEF5F27C800F6600F6600E58034C0170067005C019C03A56A805F7200002D1013F02C04E1DA7E02F18166A75FC98546C436F5FF7C000DE0A00000000000000000000000000000000000001CFFF16C4014FFFC0150340C76101584056201498C6A331008D603028521A0B605A2271417F32D40CB837EDDC60006B2754B61386963A357C978FD3D189043046CFEB7AAD0800018F85F19A000018F43C4C4013FE69EAE001C7F8F2C800057DFE9E4012F2FD003AC005801AB100FBE7ACE80032F6DD02004F68027A000A003B1006AC7001CAD5EB39009C356204D3E9980006F0500000000000000000000000000000000000000E0FFF16C4014FFFC015434042C2A098AC221A1A0CDA02158014165028D7B779977C6EAC1B46623145135ECFF99C65BF54FC7802F93F3E3441F989F112BC2451066C668E24E3E0A3383E15C0479F1388A0C0F11AF835970E2E1DCEAC003AAE68088035747A2D44324B8383D3708DFCFB6D6DE7E37A282601350025005527F001277251B002418800003E805E49580978800008DD4A003781000000000000000000000000000000007FFF16C4014FFFC015A342516141505C66751088042C4831C500500F626F17C66F40330888AAAAF80FE775729000E77E7BDBEAC000852CE370CAC6F23FAE7F1599D561F37F59DC6B72C002FC9DCF87CB9801FDA7FBFE304BF9BF5F1065F57CF1076FA35A8002AF8E8053D701301400980A5C07F2015D4037D404C03000006A0088168C220400385428660006F0B00000000000000000000000000000000000000000000000000E0FFF16C4014FFFC015C340456152D8658735A9BD252CA1519670E16DECD4E5A06969D031405A974B7409852407F7FE9A0000062D6650077D72005745EF5F76F7EF8C680004D6EEBB810000570F4200031C70E1E860005E3C5D1E8BB3F5701C6013009809E7013CE0279C04EE01700B809DC04F5404F56204D1038E98C09D003400002D90095B88001BC380000000000000000000000000000000000000000000000000000000380FFF16C4014FFFC015834045619718D4601519B452520286702C35954B5F3203DA650300197237800001A9F7AE2480023B6FD7BEA15200B2B9BFE37D6F4000153DC75C000AC7818807CD7F75001F5FC6B3900157DBFCBDB0577EBF8FECF6F46E401175D5F468005B918C0B6E005B20064015EDA0072FCFF0026E1014A00500370059C4069388034C03841B4A76310B2D60006F0500000000000000000000000000000000000000EFFF16C4014FFFC0154342516181A8CF20174AA98800C7B1996D563CAD1228020DE003A3FD7BF0B819E6005EEF70FB7F7BDDF8FA7580058B10886433786ED78A072E9D5C7A1316339D1559775F74056DA8A17DDF0C804B10090037A029D140C1DFF8AE109E3DE7FE5620001A2013009E101BDE500805F053ADDD6264BEE35B4F580000DEC000065017A9B01D6EEB3000012882CB06F0200000000000000000000000000000000E0FFF16C4014FFFC0154341474111418F8619197364020B71A46F1C37412169CA2C3BFF835918DD5AA6BC1FC4EE135545D4CAECEBDCE739425B2CB28B346A48F2BC2F57A3E966FF3BEE7384795BAD2FBE7E47C7065BD78FF1FE38093B7FD385ECECB79F7E7D1CD168EB76BABB386F97958B0E5DD0D9B84C4E17B002788008928AE2D6B85D52C15BD0CD528BCE2004601613E217BD80260AB0134A0554013BA85400650000000000EFFF16C4014FFFC015C340476101C92C202738CDA682628C8DBA757ADE8AED3200620003115643745F63FCE7D7FA700C73CC18E3D0D449A9D7B2D6CB03B2FD2F89C8802E33017ABE4F0F4EC0158018F65E1CE1000314400FF80056000BDC2019000CA0C208063145C297800B53B5CA7C271000018AE00A0172DCF668EA302D7C5689DF9D850006F10000000000000000000000000000000000000000000000000000000000000E0FFF16C4014FFFC0158340476193D85CC02528BD1050E186ECAB2DD5EEB12EB05A2370206E00002CA2277E6000035FFA6DC00DF320431F4390082282000CC02EFBAE688008005753948C7EBFCF84C482E26006B8F4D80BD2406B8FC7720066E029B833052012D01A400BC000FA8025C202C072003D8007698036E400953CF128BA4D3F95440A9F944006F0D000000000000000000000000000000000000000000000000000000E0FFF16C4014FFFC01543400282A0CA0EE01120058840C01C307B7785A255000A000F9BB76180C37584F2CDBB6E7220B990187CB3F2DEE3130115C1AC821AFCFD1FF13FA6EC0CB01AFF42D209C053A504A229E7BB2150D2D213EA7C55E2FCD7AA8D2FCEF64CF696284F1AFA400A6E8009800CA00D9CD953B343E07160DAC542ED3B3182508441300062A440628F87C9131861A47F8E50006F000000000000000000000000000000EFFF16C4014FFFC015C340476211408028280B88D0311710C41182097D2666DD6ABC7003E1E8BFF00022628336ED9C5B66380D285FDE70843A316EACF23F3FB71EDED74C6F2A68294B9177A8FCCE060008493DDF43EC7FBFE3063074F063C04B5BEF7EB30257D368EBD7ADF86B96B84A6E6882312412568216015A8A009056800A3A11564328166C001400BC480822208CC02602E29CEEA800DA00000000000000000000000001CFFF16C4014FFFC0148340C92A3D1B76C580161AD1776774EB9E742634391F40D805FEC3FF03C00009C001ABE67CFBDDFE3731800D5DD1205B8DB78B9749801BEC037BA3F79E306E06935788745BB027D17A28006688224CD10202861004D38037510DB05AFA40069560002FA800130018784005EFBB884C0850476E60000DE300000000000000000000000000000000000000000000000000000000000000000000000000001C0FFF16C4014FFFC014A340C961760D80278185686EC165EAEF5D656EB137C8A9BCDEF5FF9E8000FAC3D063D28018FDFF2400BEBFF83E369019AFA3F43F4B4F1B015C7EDB5F1800CFC4E4F06002B0D7C7C219EA80D605260A6E04AE09834441981302EE400675436A605E840B920B0250F0CF427EE88000B819808837C081007CFE3156E6F13000000000000000000000000000000000000000000000000000000000000000000E0FFF16C4014FFFC0148342587C3C0053117AF6C78074D1E1AEAB76121179E732E874233CE45CDDFDEBFF8F3D8022F97EE3E8680567A1DE7F2BD9E1312A9657BBE5DEB5A406F6009F281D2A20A88DA5CC0384128832E6887DF320B6EEC00240580027B20048CD14A46108574CB0D30358088013C20151500D1091A5A200BB94C2000DE2A0000000000000000000000000000000000000000000000000000000000000000000001C0FFF16C4016BFFC01503400303B0A068241A29860279052CD960A80E2D15CB5D7385A22712A15CA45866D818401199461723D33DC7ECD9A8F1F03711213983808E2AF4610160D8389FF758A19222790200C3CA384D8DB0858402218F271E110893FBFF2F1E078B5AC54AF87F76578CB5CAB0698974080DC740C18E0AF3C025524953AB95691090B900B946305C19D580ACE80C73B9612054D60035EF0E50005C0E28005B2161800DFF4F73E7CFDC74023C310400070FFF16C40133FFC01543425A760089030151BAB59556F6BE129AF1CBDBBC0802909EFE4BB425D77FC3E0002BD2B812015AFF24BA02B9DC1FCC7560B06CF19981F88EE866FC3031869FDD1119BEEC0DD69065C200100B0A809E109E109F00016DD0251003344028A6905A15000118001280586485BC1ABAA16D7AD49D32800037850000000000000000000000000000000000000000000000007FFF16C4014FFFC014A3414961959DC02AE4522B77072D2D68F6BE78E70EABD16885A495757998F2CD605CD54FFB7D9101A68001E8FB001CBFF37F4D854A4CB0E77D83F4599015D86A8019F920033E76402213805BFFA7804FD9F2039E19E2180080630C8064037E0C80A444D416940150DFC42F406880557958009810340000D01B8D4EC76494B87646F0D000000000000000000000000000000000000000000000000000000E0FFF16C4014FFFC015434002C2B14AC52A3162158CCD11479600681C56F2C01885DCAE4A7B3C7A33636B4EA5E694082FC68E5814BA519CC958FDEF8B8C00ACB29A95C072BA6CA4031C4006AE2000600A610C4079A04BF2C0314BF80A897A2630A8C3378CE63004394480021000260803602710DF48D4B6F0FCC009740000481103085F20032E2F22910220001BC2800000000000000000000000000000000000000000000000380FFF16C4014FFFC014C34042C2B110A82C13980854ADD80005230BF2CC7175BB08590EBB7F0580F7590E807154EE799C597591A31430F9424E00414F273FCB7E0C2464067FC67DC6012FFC0FC0801088067E9F100CFFFEBFF0DD58067E7F23A66974A006AD3A2C00CA017000293047776BF9A78000B80001C37D40094C040B0069E0595B7513B800DE1E0000000000000000000000000000000000000000000000000000000001CFFF16C4014FFFC014A34002C2B0B84056111D8404E10139002A332804D2540C5C641A2F042002046A2844BA78034751FC450E3EDCB00D4BE830F43E595C5963213DCA8C0056B7C9CE47711252C009B4797DC61205E3EBFA7EA9C00000C6F18003F558401BA00189A4002000522013CDB200620034AA009F082A25B5B61C33E18737F9D6CE3D4475E158BAEE66DD9D567505C1BC100000000000000000000000000000000000038";
//        byte[] test_aac_file_byte_array = Helpers.hexStringToByteArray(test_aac_file_hex_string);
//        File test_aac_file = new File(getExternalCacheDir().getAbsolutePath() + "/test.aac");
//
//        OutputStream os = null;
//        try {
//            os = new FileOutputStream(test_aac_file);
//            os.write(test_aac_file_byte_array);
//            os.close();
//        } catch (FileNotFoundException e) {
//            e.printStackTrace();
//        } catch (IOException e) {
//            e.printStackTrace();
//        }

    // code for reading out files as hex strings
//        int currentFileNum = 0;
//        for (int i = 0; i < 37; i++) {
//            byte[] buf = new byte[20000];
//            byte[] real_contents = null;
//
//            FileInputStream is = null;
//            int read_size = 0;
//            try {
//                is = new FileInputStream(getExternalCacheDir().getAbsolutePath() + "/" + currentFileNum + ".aac");
//                read_size = is.available();
//                is.read(buf, 0, read_size);
//                real_contents = Arrays.copyOf(buf, read_size);
//            } catch (FileNotFoundException e) {
//                e.printStackTrace();
//            } catch (IOException e) {
//                e.printStackTrace();
//            }
//
//            Log.d(TAG, "Contents of " + currentFileNum + ".aac (length: " + read_size + "):");
//            Helpers.printLongString(TAG, Helpers.bytesToHex(real_contents));
//
//            currentFileNum++;
//        }


    }

    @Override
    protected void onDestroy() {
        super.onDestroy();

        LocalBroadcastManager.getInstance(this).unregisterReceiver(AACADTSFrameProcessorListener);
    }
}